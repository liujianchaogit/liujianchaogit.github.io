import{B,D as F,d as D,_ as G}from"./index-C1TKk8vI.js";import{_ as J}from"./DictTag.vue_vue_type_script_lang-B3VNccaT.js";import{d as K}from"./formatTime-EbFUBcAO.js";import{g as V,P as f,d as $,a as H}from"./index-BuK0ap75.js";import{_ as Q}from"./PermissionForm.vue_vue_type_script_setup_true_lang-C_qKaUAE.js";import{_ as X,f as Y,i as Z,$ as ee,aj as ae}from"./form-designer-BpYekVAY.js";import{x as le,r as n,f as T,y as v,z as ie,E as y,F as c,u as s,O as t,K as I,J as w,G as te,M as se}from"./form-create-7GAbgMwl.js";const re=le({name:"CrmPermissionList",__name:"PermissionList",props:{bizType:{},bizId:{},showAction:{type:Boolean}},emits:["quitTeam"],setup(x,{expose:N,emit:O}){const o=D(),u=x,k=n(!0),r=n([]),U=n({ownerUserId:0}),g=B(),z=async()=>{k.value=!0;try{const a=await V({bizType:u.bizType,bizId:u.bizId});r.value=a,r.value.find(e=>e.userId===g.getUser.id&&e.level===f.OWNER)&&(U.value.ownerUserId=g.getUser.id)}finally{k.value=!1}},d=n([]),E=n(),C=a=>{var e;if(a.findIndex(l=>l.level===f.OWNER)!==-1)return o.warning("\u4E0D\u80FD\u9009\u62E9\u8D1F\u8D23\u4EBA\uFF01"),void((e=E.value)==null?void 0:e.clearSelection());d.value=a},h=n(),W=()=>{var a,e,l;((a=d.value)==null?void 0:a.length)!==0?((e=d.value)==null?void 0:e.length)>1?o.warning("\u7F16\u8F91\u56E2\u961F\u6210\u5458\u65F6\u53EA\u80FD\u9009\u62E9\u4E00\u4E2A\uFF01"):(l=h.value)==null||l.open0("update",u.bizType,u.bizId,d.value[0].id,d.value[0].level):o.warning("\u8BF7\u5148\u9009\u62E9\u56E2\u961F\u6210\u5458\u540E\u64CD\u4F5C\uFF01")},P=async()=>{var e,l;if(((e=d.value)==null?void 0:e.length)===0)return void o.warning("\u8BF7\u5148\u9009\u62E9\u56E2\u961F\u6210\u5458\u540E\u64CD\u4F5C\uFF01");await o.delConfirm();const a=(l=d.value)==null?void 0:l.map(i=>i.id);await $(a),o.success("\u79FB\u9664\u56E2\u961F\u6210\u5458\u6210\u529F\uFF01"),await z()},R=()=>{var a;(a=h.value)==null||a.open("create",u.bizType,u.bizId)},p=n(!1),_=n(!1),b=n(!1);T(r,a=>{var e;if(b.value=!1,(a==null?void 0:a.length)>0){b.value=!r.value.some(i=>i.level===f.OWNER),p.value=!1,_.value=!1;const l=(e=g.getUser)==null?void 0:e.id;r.value.filter(i=>i.userId===l).forEach(i=>{i.level===f.OWNER?(p.value=!0,_.value=!0):i.level===f.WRITE&&(_.value=!0)})}else b.value=!0},{immediate:!0}),N({openForm:R,validateOwnerUser:p,validateWrite:_,isPool:b});const S=O,L=async()=>{if(r.value.find(e=>e.userId===g.getUser.id&&e.level===f.OWNER))return void o.warning("\u8D1F\u8D23\u4EBA\u4E0D\u80FD\u9000\u51FA\u56E2\u961F\uFF01");const a=r.value.find(e=>e.userId===g.getUser.id);a&&(await H(a.id),o.success("\u9000\u51FA\u56E2\u961F\u6210\u5458\u6210\u529F\uFF01"),S("quitTeam"))};return T(()=>u.bizId,a=>{a&&z()},{immediate:!0,deep:!0}),(a,e)=>{const l=G,i=Y,M=Z,m=ee,j=J,q=ae;return v(),ie(se,null,[a.showAction?(v(),y(M,{key:0,justify:"end"},{default:c(()=>[s(p)?(v(),y(i,{key:0,type:"primary",onClick:R},{default:c(()=>[t(l,{class:"mr-5px",icon:"ep:plus"}),e[0]||(e[0]=I(" \u65B0\u589E "))]),_:1})):w("",!0),s(p)?(v(),y(i,{key:1,onClick:W},{default:c(()=>[t(l,{class:"mr-5px",icon:"ep:edit"}),e[1]||(e[1]=I(" \u7F16\u8F91 "))]),_:1})):w("",!0),s(p)?(v(),y(i,{key:2,onClick:P},{default:c(()=>[t(l,{class:"mr-5px",icon:"ep:delete"}),e[2]||(e[2]=I(" \u79FB\u9664 "))]),_:1})):w("",!0),!s(p)&&s(r).length>0?(v(),y(i,{key:3,type:"danger",onClick:L},{default:c(()=>e[3]||(e[3]=[I(" \u9000\u51FA\u56E2\u961F ")])),_:1})):w("",!0)]),_:1})):w("",!0),te((v(),y(s(X),{ref_key:"elTableRef",ref:E,data:s(r),"show-overflow-tooltip":!0,stripe:!0,class:"mt-20px",onSelectionChange:C},{default:c(()=>[t(m,{type:"selection",width:"55"}),t(m,{align:"center",label:"\u59D3\u540D",prop:"nickname"}),t(m,{align:"center",label:"\u90E8\u95E8",prop:"deptName"}),t(m,{align:"center",label:"\u5C97\u4F4D",prop:"postNames"}),t(m,{align:"center",label:"\u6743\u9650\u7EA7\u522B",prop:"level"},{default:c(({row:A})=>[t(j,{type:s(F).CRM_PERMISSION_LEVEL,value:A.level},null,8,["type","value"])]),_:1}),t(m,{formatter:s(K),align:"center",label:"\u52A0\u5165\u65F6\u95F4",prop:"createTime"},null,8,["formatter"])]),_:1},8,["data"])),[[q,s(k)]]),t(Q,{ref_key:"formRef",ref:h,onSuccess:z},null,512)],64)}}});export{re as _};
