import{V as P,d as de,aB as me,L as F,_ as pe,c as fe}from"./index-C1TKk8vI.js";import{x as ve,r as v,X as ye,c as V,u as s,ae as he,aq as Te,y as d,E as I,F as p,O as o,C as S,L as G,z as R,M as ge,a4 as we,J as h,H as W,G as Q,P as xe,l as ke,a5 as Me,U as _e,n as Ee}from"./form-create-7GAbgMwl.js";import{_ as Ie}from"./EmojiSelectPopover.vue_vue_type_script_setup_true_lang-BC8FAYKn.js";import{_ as Se}from"./PictureSelectUpload.vue_vue_type_script_setup_true_lang-Bi9xU8rs.js";import Ne from"./ProductItem-CdAfGMsV.js";import be from"./OrderItem-BZdVJw6H.js";import{u as Ue}from"./emoji-DIhFXR2A.js";import{u as Le,K as T}from"./kefu-Dtwn5LP3.js";import{U as j}from"./constants-IYPHa1Ih.js";import{f as Z}from"./formatTime-EbFUBcAO.js";import{a as Re,ax as J,ar as Ae,X as Ke,af as Xe,ak as Be,e as Ce,Y as He,k as Ve,aa as je,V as Oe,aN as De}from"./form-designer-BpYekVAY.js";import"./picture-CTjip5lJ.js";const Pe=async m=>await P.post({url:"/promotion/kefu-message/send",data:m}),Fe=async m=>await P.put({url:"/promotion/kefu-message/update-read-status?conversationId="+m}),Ge=async m=>await P.get({url:"/promotion/kefu-message/list",params:m});var Je={exports:{}};const Ye=Re(Je.exports=function(m,O,i){m=m||{};var g=O.prototype,X={future:"in %s",past:"%s ago",s:"a few seconds",m:"a minute",mm:"%d minutes",h:"an hour",hh:"%d hours",d:"a day",dd:"%d days",M:"a month",MM:"%d months",y:"a year",yy:"%d years"};function u(r,l,k,M){return g.fromToBase(r,l,k,M)}i.en.relativeTime=X,g.fromToBase=function(r,l,k,M,N){for(var c,_,b,A=k.$locale().relativeTime||X,w=m.thresholds||[{l:"s",r:44,d:"second"},{l:"m",r:89},{l:"mm",r:44,d:"minute"},{l:"h",r:89},{l:"hh",r:21,d:"hour"},{l:"d",r:35},{l:"dd",r:25,d:"day"},{l:"M",r:45},{l:"MM",r:10,d:"month"},{l:"y",r:17},{l:"yy",d:"year"}],D=w.length,y=0;y<D;y+=1){var f=w[y];f.d&&(c=M?i(r).diff(k,f.d,!0):k.diff(r,f.d,!0));var x=(m.rounding||Math.round)(Math.abs(c));if(b=c>0,x<=f.r||!f.r){x<=1&&y>0&&(f=w[y-1]);var K=A[f.l];N&&(x=N(""+x)),_=typeof K=="string"?K.replace("%d",x):K(x,l,f.l,b);break}}if(l)return _;var U=b?A.future:A.past;return typeof U=="function"?U(_):U.replace("%s",_)},g.to=function(r,l){return u(r,l,this,!0)},g.from=function(r,l){return u(r,l,this)};var n=function(r){return r.$u?i.utc():i()};g.toNow=function(r){return this.to(n(this),r)},g.fromNow=function(r){return this.from(n(this),r)}}),$e={class:"kefu-title"},qe={class:"flex justify-center items-center mb-20px"},ze={key:0,class:"date-message"},We={key:1,class:"system-message"},Qe={key:0,class:"line-height-normal text-justify h-1/1 w-full"},Ze={class:"chat-tools flex items-center"},ea=fe(ve({name:"KeFuMessageList",__name:"KeFuMessageList",setup(m,{expose:O}){J.extend(Ye);const i=v(""),{replaceEmoji:g}=Ue(),X=de(),u=v([]),n=v({}),r=v(!1),l=ye({conversationId:0,createTime:void 0}),k=v(0),M=v(!1),N=Le(),c=V(()=>e=>me(e.content)),_=async()=>{const e=await Ge(l);if(F(e))y.value=!0;else{if(l.createTime=Z(e.at(-1).createTime),l.createTime)for(const t of e)b(t);else u.value=e;M.value=!0}},b=e=>{u.value.some(t=>t.id===e.id)||u.value.push(e)},A=V(()=>(u.value.sort((e,t)=>e.createTime-t.createTime),u.value)),w=async e=>{if(n.value){if(e!==void 0){if(e.conversationId!==n.value.id)return;b(e)}else l.createTime=void 0,await _();L.value?r.value=!0:await Y()}};O({getNewMessageList:async e=>{N.saveMessageList(n.value.id,u.value),u.value=N.getConversationMessageList(e.id)||[],k.value=u.value.length||0,L.value=!1,M.value=!1,y.value=!1,n.value=e,l.conversationId=e.id,l.createTime=void 0,await w()},refreshMessageList:w});const D=V(()=>!F(n.value)),y=v(!1),f=e=>{i.value+=e.name},x=async e=>{const t={conversationId:n.value.id,contentType:T.IMAGE,content:JSON.stringify({picUrl:e})};await U(t)},K=async e=>{var E;if(e.shiftKey)return;if(F((E=s(i.value))==null?void 0:E.trim()))return X.notifyWarning("\u8BF7\u8F93\u5165\u6D88\u606F\u540E\u518D\u53D1\u9001\u54E6\uFF01"),void(i.value="");const t={conversationId:n.value.id,contentType:T.TEXT,content:JSON.stringify({text:i.value})};await U(t)},U=async e=>{await Pe(e),i.value="",await w(),await N.updateConversation(n.value.id)},B=v(),C=v(),Y=async()=>{L.value=!1,await(async()=>{L.value||(await Ee(),C.value.setScrollTop(B.value.clientHeight),r.value=!1,await Fe(n.value.id))})()},L=v(!1),ee=Ae(({scrollTop:e})=>{var E;if(y.value)return;Math.floor(e)===0&&ae();const t=(E=C.value)==null?void 0:E.wrapRef;Math.abs(t.scrollHeight-t.clientHeight-t.scrollTop)<1&&(L.value=!1,w())},200),ae=async()=>{var t;const e=(t=B.value)==null?void 0:t.clientHeight;e&&(L.value=!0,await _(),C.value.setScrollTop(B.value.clientHeight-e))},se=V(()=>(e,t)=>s(u.value)[t+1]?J(s(u.value)[t+1].createTime).fromNow()!==J(s(e).createTime).fromNow():!1);return(e,t)=>{const E=Ke,$=Xe,H=he("MessageItem"),te=Be,re=Ce,le=pe,q=He,ne=Ve,oe=je,z=Oe,ie=De,ue=Te("dompurify-html");return s(D)?(d(),I(z,{key:0,class:"kefu"},{default:p(()=>[o(E,{class:"kefu-header"},{default:p(()=>[S("div",$e,G(s(n).userNickname),1)]),_:1}),o(q,{class:"kefu-content overflow-visible"},{default:p(()=>[o(re,{ref_key:"scrollbarRef",ref:C,always:"",onScroll:s(ee)},{default:p(()=>[s(M)?(d(),R("div",{key:0,ref_key:"innerRef",ref:B,class:"w-[100%] px-10px"},[(d(!0),R(ge,null,we(s(A),(a,ce)=>(d(),R("div",{key:a.id,class:"w-[100%]"},[S("div",qe,[a.contentType!==s(T).SYSTEM&&s(se)(a,ce)?(d(),R("div",ze,G(s(Z)(a.createTime)),1)):h("",!0),a.contentType===s(T).SYSTEM?(d(),R("div",We,G(a.content),1)):h("",!0)]),S("div",{class:W([[a.senderType===s(j).MEMBER?"ss-row-left":a.senderType===s(j).ADMIN?"ss-row-right":""],"flex mb-20px w-[100%]"])},[a.senderType===s(j).MEMBER?(d(),I($,{key:0,src:s(n).userAvatar,alt:"avatar",class:"w-60px h-60px"},null,8,["src"])):h("",!0),S("div",{class:W({"kefu-message":s(T).TEXT===a.contentType})},[o(H,{message:a},{default:p(()=>[s(T).TEXT===a.contentType?Q((d(),R("div",Qe,null,512)),[[ue,s(g)(s(c)(a).text||a.content)]]):h("",!0)]),_:2},1032,["message"]),o(H,{message:a},{default:p(()=>[s(T).IMAGE===a.contentType?(d(),I(te,{key:0,"initial-index":0,"preview-src-list":[s(c)(a).picUrl||a.content],src:s(c)(a).picUrl||a.content,class:"w-200px mx-10px",fit:"contain","preview-teleported":""},null,8,["preview-src-list","src"])):h("",!0)]),_:2},1032,["message"]),o(H,{message:a},{default:p(()=>[s(T).PRODUCT===a.contentType?(d(),I(Ne,{key:0,picUrl:s(c)(a).picUrl,price:s(c)(a).price,"sales-count":s(c)(a).salesCount,spuId:s(c)(a).spuId,stock:s(c)(a).stock,title:s(c)(a).spuName,class:"max-w-300px mx-10px"},null,8,["picUrl","price","sales-count","spuId","stock","title"])):h("",!0)]),_:2},1032,["message"]),o(H,{message:a},{default:p(()=>[s(T).ORDER===a.contentType?(d(),I(be,{key:0,message:a,class:"max-w-100% mx-10px"},null,8,["message"])):h("",!0)]),_:2},1032,["message"])],2),a.senderType===s(j).ADMIN?(d(),I($,{key:1,src:a.senderAvatar,alt:"avatar"},null,8,["src"])):h("",!0)],2)]))),128))],512)):h("",!0)]),_:1},8,["onScroll"]),Q(S("div",{class:"newMessageTip flex items-center cursor-pointer",onClick:Y},[t[1]||(t[1]=S("span",null,"\u6709\u65B0\u6D88\u606F",-1)),o(le,{class:"ml-5px",icon:"ep:bottom"})],512),[[xe,s(r)]])]),_:1}),o(oe,{class:"kefu-footer"},{default:p(()=>[S("div",Ze,[o(Ie,{onSelectEmoji:f}),o(Se,{class:"ml-15px mt-3px cursor-pointer",onSendPicture:x})]),o(ne,{modelValue:s(i),"onUpdate:modelValue":t[0]||(t[0]=a=>ke(i)?i.value=a:null),rows:6,placeholder:"\u8F93\u5165\u6D88\u606F\uFF0CEnter\u53D1\u9001\uFF0CShift+Enter\u6362\u884C",style:{"border-style":"none"},type:"textarea",onKeyup:Me(_e(K,["prevent"]),["enter"])},null,8,["modelValue","onKeyup"])]),_:1})]),_:1})):(d(),I(z,{key:1,class:"kefu"},{default:p(()=>[o(q,null,{default:p(()=>[o(ie,{description:"\u8BF7\u9009\u62E9\u5DE6\u4FA7\u7684\u4E00\u4E2A\u4F1A\u8BDD\u540E\u5F00\u59CB"})]),_:1})]),_:1}))}}}),[["__scopeId","data-v-39d9583a"]]);export{ea as default};
