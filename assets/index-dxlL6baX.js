import{e as he,d as we,_ as Ce,c as ge}from"./index-DiGvuAxb.js";import{k as ke,r as l,c as _e,e as Te,y as w,m as p,z as c,H as i,u as t,v as d,l as W,C as y,E as q,F as A,A as xe,h as X,a8 as Ie,n as B}from"./form-create-D7wT855o.js";import{C as H}from"./index-D7arh0zA.js";import{C as Oe}from"./index-BnSnpYRs.js";import be from"./ConversationList-BJ2DQSbx.js";import{_ as ze}from"./ConversationUpdateForm.vue_vue_type_script_setup_true_lang-vUs4sg07.js";import Me from"./MessageList-DRj424Zs.js";import De from"./MessageListEmpty-DXsNqOD6.js";import Ee from"./MessageLoading-DpXDsDbe.js";import Le from"./MessageNewConversation-C5xzDOBy.js";import{U as Re,W as Se,f as Ue,X as Ve,a9 as qe,D as Ae}from"./form-designer-drfGvdgz.js";import"./fetch-D5K_4anA.js";import"./RoleRepository-CblW3ki2.js";import"./RoleHeader-CvEUfQh3.js";import"./RoleList-DI5JP5xy.js";import"./ChatRoleForm.vue_vue_type_script_setup_true_lang-XtFwfXNX.js";import"./Dialog.vue_vue_type_style_index_0_lang-WG3ZquOK.js";import"./constants-C3gLHYOK.js";import"./index-DJwvf2H9.js";import"./constants-CHvLs4wt.js";import"./index-BjDTSUtW.js";import"./index-BNzDiiC2.js";import"./RoleCategoryList-DDqRDAga.js";import"./gpt-WhTktY3S.js";import"./formatTime-DeTj2b0K.js";import"./index-CY7R6inO.js";import"./index-brTT8YwK.js";import"./MessageKnowledge.vue_vue_type_script_setup_true_lang-BorCE8gD.js";import"./avatar-BG6NdH5s.js";const Be={class:"title"},He={key:0},Ke={key:0,class:"btns"},Ne=["innerHTML"],je={class:"message-container"},Fe={class:"prompt-from"},$e={class:"prompt-btns"},Ge=ke({name:"AiChat",__name:"index",setup(Pe){const K=he(),f=we(),N=l(),n=l(null),u=l(null),r=l(!1),I=l(),s=l([]),C=l(!1),D=l(),T=l(50),E=l(!1),g=l(!1),O=l(),L=l(),m=l(),b=l(!0),k=l(""),z=l(""),j=async e=>{if(!e)return;const a=await Oe.getChatConversationMy(e);a&&(u.value=a,n.value=a.id)},Q=async e=>r.value?(f.alert("\u5BF9\u8BDD\u4E2D\uFF0C\u4E0D\u5141\u8BB8\u5207\u6362!"),!1):(n.value=e.id,u.value=e,await R(),x(!0),m.value="",!0),Y=async e=>{n.value===e.id&&await F()},F=async()=>{if(r.value)return f.alert("\u5BF9\u8BDD\u4E2D\uFF0C\u4E0D\u5141\u8BB8\u5207\u6362!"),!1;n.value=null,u.value=null,s.value=[]},$=l(),Z=async()=>{$.value.open(n.value)},ee=async()=>{await j(n.value)},ae=async()=>{await N.value.createConversation()},te=async()=>{m.value=""},R=async()=>{try{if(n.value===null)return;D.value=setTimeout(()=>{C.value=!0},60),s.value=await H.getChatMessageListByConversationId(n.value),await B(),await x()}finally{D.value&&clearTimeout(D.value),C.value=!1}},S=_e(()=>{var e;return s.value.length>0?s.value:(e=u.value)!=null&&e.systemMessage?[{id:0,type:"system",content:u.value.systemMessage}]:[]}),le=()=>{r.value?f.alert("\u56DE\u7B54\u4E2D\uFF0C\u4E0D\u80FD\u5220\u9664!"):R()},ne=async()=>{if(n.value)try{await f.delConfirm("\u786E\u8BA4\u6E05\u7A7A\u5BF9\u8BDD\u6D88\u606F\uFF1F"),await H.deleteByConversationId(n.value),s.value=[]}catch{}},oe=()=>{I.value.handlerGoTop()},se=async e=>{var o;if(g.value||r.value)return;const a=(o=m.value)==null?void 0:o.trim();e.key==="Enter"&&(e.shiftKey?(m.value+=`\r
`,e.preventDefault()):(await M(a),e.preventDefault()))},ie=()=>{var e;M((e=m.value)==null?void 0:e.trim())},ue=e=>{if(!g.value){if(e.data==null)return;g.value=!0}L.value&&clearTimeout(L.value),L.value=setTimeout(()=>{g.value=!1},400)},re=()=>{g.value=!0},ve=()=>{setTimeout(()=>{g.value=!1},200)},M=async e=>{e.length<1?f.error("\u53D1\u9001\u5931\u8D25\uFF0C\u539F\u56E0\uFF1A\u5185\u5BB9\u4E3A\u7A7A\uFF01"):n.value!=null?(m.value="",await ce({conversationId:n.value,content:e})):f.error("\u8FD8\u6CA1\u521B\u5EFA\u5BF9\u8BDD\uFF0C\u4E0D\u80FD\u53D1\u9001!")},ce=async e=>{O.value=new AbortController,r.value=!0,k.value="";try{s.value.push({id:-1,conversationId:n.value,type:"user",content:e.content,createTime:new Date}),s.value.push({id:-2,conversationId:n.value,type:"assistant",content:"\u601D\u8003\u4E2D...",createTime:new Date}),await B(),await x(),de();let a=!0;await H.sendChatMessageStream(e.conversationId,e.content,O.value,b.value,async o=>{const{code:v,data:_,msg:V}=JSON.parse(o.data);v===0?_.receive.content!==""&&(a&&(a=!1,s.value.pop(),s.value.pop(),s.value.push(_.send),s.value.push(_.receive)),k.value=k.value+_.receive.content,await x()):f.alert(`\u5BF9\u8BDD\u5F02\u5E38! ${V}`)},o=>{throw f.alert(`\u5BF9\u8BDD\u5F02\u5E38! ${o}`),U(),o},()=>{U()})}catch{}},U=async()=>{O.value&&O.value.abort(),r.value=!1},me=e=>{m.value=e.content},pe=e=>{M(e.content)},x=async e=>{await B(),I.value&&I.value.scrollToBottom(e)},de=async()=>{let e=0;try{if(E.value)return;E.value=!0,z.value="";const a=async()=>{const v=(k.value.length-z.value.length)/10;T.value=v>5?10:v>2?30:v>1.5?50:100,r.value||(T.value=10),e<k.value.length?(z.value+=k.value[e],e++,s.value[s.value.length-1].content=z.value,await x(),o=setTimeout(a,T.value)):r.value?o=setTimeout(a,T.value):(E.value=!1,clearTimeout(o))};let o=setTimeout(a,T.value)}catch{}};return Te(async()=>{if(K.query.conversationId){const e=K.query.conversationId;n.value=e,await j(e)}C.value=!0,await R()}),(e,a)=>{const o=Ce,v=Ue,_=Se,V=Ve,fe=Ae,ye=qe,G=Re;return p(),w(G,{class:"ai-layout"},{default:c(()=>[i(be,{"active-id":t(n),ref_key:"conversationListRef",ref:N,onOnConversationCreate:te,onOnConversationClick:Q,onOnConversationClear:F,onOnConversationDelete:Y},null,8,["active-id"]),i(G,{class:"detail-container"},{default:c(()=>[i(_,{class:"header"},{default:c(()=>{var h,J;return[d("div",Be,[q(A((h=t(u))!=null&&h.title?(J=t(u))==null?void 0:J.title:"\u5BF9\u8BDD")+" ",1),t(s).length?(p(),W("span",He,"("+A(t(s).length)+")",1)):y("",!0)]),t(u)?(p(),W("div",Ke,[i(v,{type:"primary",bg:"",plain:"",size:"small",onClick:Z},{default:c(()=>{var P;return[d("span",{innerHTML:(P=t(u))==null?void 0:P.modelName},null,8,Ne),i(o,{icon:"ep:setting",class:"ml-10px"})]}),_:1}),i(v,{size:"small",class:"btn",onClick:ne},{default:c(()=>[i(o,{icon:"heroicons-outline:archive-box-x-mark",color:"#787878"})]),_:1}),i(v,{size:"small",class:"btn"},{default:c(()=>[i(o,{icon:"ep:download",color:"#787878"})]),_:1}),i(v,{size:"small",class:"btn",onClick:oe},{default:c(()=>[i(o,{icon:"ep:top",color:"#787878"})]),_:1})])):y("",!0)]}),_:1}),i(V,{class:"main-container"},{default:c(()=>[d("div",null,[d("div",je,[t(C)?(p(),w(Ee,{key:0})):y("",!0),t(u)?y("",!0):(p(),w(Le,{key:1,onOnNewConversation:ae})),!t(C)&&t(S).length===0&&t(u)?(p(),w(De,{key:2,onOnPrompt:M})):y("",!0),!t(C)&&t(S).length>0?(p(),w(Me,{key:3,ref_key:"messageRef",ref:I,conversation:t(u),list:t(S),onOnDeleteSuccess:le,onOnEdit:me,onOnRefresh:pe},null,8,["conversation","list"])):y("",!0)])])]),_:1}),i(ye,{class:"footer-container"},{default:c(()=>[d("form",Fe,[xe(d("textarea",{class:"prompt-input","onUpdate:modelValue":a[0]||(a[0]=h=>X(m)?m.value=h:null),onKeydown:se,onInput:ue,onCompositionstart:re,onCompositionend:ve,placeholder:"\u95EE\u6211\u4EFB\u4F55\u95EE\u9898...\uFF08Shift+Enter \u6362\u884C\uFF0C\u6309\u4E0B Enter \u53D1\u9001\uFF09"},null,544),[[Ie,t(m)]]),d("div",$e,[d("div",null,[i(fe,{modelValue:t(b),"onUpdate:modelValue":a[1]||(a[1]=h=>X(b)?b.value=h:null)},null,8,["modelValue"]),a[3]||(a[3]=d("span",{class:"ml-5px text-14px text-#8f8f8f"},"\u4E0A\u4E0B\u6587",-1))]),t(r)==0?(p(),w(v,{key:0,type:"primary",size:"default",onClick:ie,loading:t(r)},{default:c(()=>[q(A(t(r)?"\u8FDB\u884C\u4E2D":"\u53D1\u9001"),1)]),_:1},8,["loading"])):y("",!0),t(r)==1?(p(),w(v,{key:1,type:"danger",size:"default",onClick:a[2]||(a[2]=h=>U())},{default:c(()=>a[4]||(a[4]=[q(" \u505C\u6B62 ")])),_:1})):y("",!0)])])]),_:1})]),_:1}),i(ze,{ref_key:"conversationUpdateFormRef",ref:$,onSuccess:ee},null,512)]),_:1})}}}),Je=ge(Ge,[["__scopeId","data-v-43d55f99"]]);export{Je as default};
