import{V as X,d as de,aB as me,L as F,_ as pe,c as fe}from"./index-DiGvuAxb.js";import{k as ve,r as v,P as ye,c as j,u as s,a6 as he,af as Te,y as I,m as d,z as p,H as o,v as S,F as G,A as Z,l as L,C as h,G as ge,$ as we,B as q,I as xe,Z as ke,M as Me,h as _e,n as Ee}from"./form-create-D7wT855o.js";import{_ as Ie}from"./EmojiSelectPopover.vue_vue_type_script_setup_true_lang-C9rRuw8a.js";import{_ as Se}from"./PictureSelectUpload.vue_vue_type_script_setup_true_lang-C0GfhAXa.js";import Ne from"./ProductItem-ibFt7DPP.js";import be from"./OrderItem-rWLxq3ja.js";import{u as Ue}from"./emoji-CLBs8lTh.js";import{u as Re,K as T}from"./kefu-B6ZaZw68.js";import{U as D}from"./constants-C3gLHYOK.js";import{f as Q}from"./formatTime-DeTj2b0K.js";import{a as Le,ax as $,ar as Ae,U as He,W as Be,e as Ce,ag as Ke,ak as Oe,X as je,k as De,a9 as Ve,aN as Pe}from"./form-designer-drfGvdgz.js";import"./picture-CTjip5lJ.js";const Xe=async m=>await X.post({url:"/promotion/kefu-message/send",data:m}),Fe=async m=>await X.put({url:"/promotion/kefu-message/update-read-status?conversationId="+m}),Ge=async m=>await X.get({url:"/promotion/kefu-message/list",params:m});var $e={exports:{}};const Je=Le($e.exports=function(m,V,i){m=m||{};var g=V.prototype,B={future:"in %s",past:"%s ago",s:"a few seconds",m:"a minute",mm:"%d minutes",h:"an hour",hh:"%d hours",d:"a day",dd:"%d days",M:"a month",MM:"%d months",y:"a year",yy:"%d years"};function u(r,l,k,M){return g.fromToBase(r,l,k,M)}i.en.relativeTime=B,g.fromToBase=function(r,l,k,M,N){for(var c,_,b,A=k.$locale().relativeTime||B,w=m.thresholds||[{l:"s",r:44,d:"second"},{l:"m",r:89},{l:"mm",r:44,d:"minute"},{l:"h",r:89},{l:"hh",r:21,d:"hour"},{l:"d",r:35},{l:"dd",r:25,d:"day"},{l:"M",r:45},{l:"MM",r:10,d:"month"},{l:"y",r:17},{l:"yy",d:"year"}],P=w.length,y=0;y<P;y+=1){var f=w[y];f.d&&(c=M?i(r).diff(k,f.d,!0):k.diff(r,f.d,!0));var x=(m.rounding||Math.round)(Math.abs(c));if(b=c>0,x<=f.r||!f.r){x<=1&&y>0&&(f=w[y-1]);var H=A[f.l];N&&(x=N(""+x)),_=typeof H=="string"?H.replace("%d",x):H(x,l,f.l,b);break}}if(l)return _;var U=b?A.future:A.past;return typeof U=="function"?U(_):U.replace("%s",_)},g.to=function(r,l){return u(r,l,this,!0)},g.from=function(r,l){return u(r,l,this)};var n=function(r){return r.$u?i.utc():i()};g.toNow=function(r){return this.to(n(this),r)},g.fromNow=function(r){return this.from(n(this),r)}}),We={class:"kefu-title"},Ye={class:"flex justify-center items-center mb-20px"},ze={key:0,class:"date-message"},Ze={key:1,class:"system-message"},qe={key:0,class:"line-height-normal text-justify h-1/1 w-full"},Qe={class:"chat-tools flex items-center"},ea=fe(ve({name:"KeFuMessageList",__name:"KeFuMessageList",setup(m,{expose:V}){$.extend(Je);const i=v(""),{replaceEmoji:g}=Ue(),B=de(),u=v([]),n=v({}),r=v(!1),l=ye({conversationId:0,createTime:void 0}),k=v(0),M=v(!1),N=Re(),c=j(()=>e=>me(e.content)),_=async()=>{const e=await Ge(l);if(F(e))y.value=!0;else{if(l.createTime=Q(e.at(-1).createTime),l.createTime)for(const t of e)b(t);else u.value=e;M.value=!0}},b=e=>{u.value.some(t=>t.id===e.id)||u.value.push(e)},A=j(()=>(u.value.sort((e,t)=>e.createTime-t.createTime),u.value)),w=async e=>{if(n.value){if(e!==void 0){if(e.conversationId!==n.value.id)return;b(e)}else l.createTime=void 0,await _();R.value?r.value=!0:await J()}};V({getNewMessageList:async e=>{N.saveMessageList(n.value.id,u.value),u.value=N.getConversationMessageList(e.id)||[],k.value=u.value.length||0,R.value=!1,M.value=!1,y.value=!1,n.value=e,l.conversationId=e.id,l.createTime=void 0,await w()},refreshMessageList:w});const P=j(()=>!F(n.value)),y=v(!1),f=e=>{i.value+=e.name},x=async e=>{const t={conversationId:n.value.id,contentType:T.IMAGE,content:JSON.stringify({picUrl:e})};await U(t)},H=async e=>{var E;if(e.shiftKey)return;if(F((E=s(i.value))==null?void 0:E.trim()))return B.notifyWarning("\u8BF7\u8F93\u5165\u6D88\u606F\u540E\u518D\u53D1\u9001\u54E6\uFF01"),void(i.value="");const t={conversationId:n.value.id,contentType:T.TEXT,content:JSON.stringify({text:i.value})};await U(t)},U=async e=>{await Xe(e),i.value="",await w(),await N.updateConversation(n.value.id)},C=v(),K=v(),J=async()=>{R.value=!1,await(async()=>{R.value||(await Ee(),K.value.setScrollTop(C.value.clientHeight),r.value=!1,await Fe(n.value.id))})()},R=v(!1),ee=Ae(({scrollTop:e})=>{var E;if(y.value)return;Math.floor(e)===0&&ae();const t=(E=K.value)==null?void 0:E.wrapRef;Math.abs(t.scrollHeight-t.clientHeight-t.scrollTop)<1&&(R.value=!1,w())},200),ae=async()=>{var t;const e=(t=C.value)==null?void 0:t.clientHeight;e&&(R.value=!0,await _(),K.value.setScrollTop(C.value.clientHeight-e))},se=j(()=>(e,t)=>s(u.value)[t+1]?$(s(u.value)[t+1].createTime).fromNow()!==$(s(e).createTime).fromNow():!1);return(e,t)=>{const E=Be,W=Ke,O=he("MessageItem"),te=Oe,re=Ce,le=pe,Y=je,ne=De,oe=Ve,z=He,ie=Pe,ue=Te("dompurify-html");return s(P)?(d(),I(z,{key:0,class:"kefu"},{default:p(()=>[o(E,{class:"kefu-header"},{default:p(()=>[S("div",We,G(s(n).userNickname),1)]),_:1}),o(Y,{class:"kefu-content overflow-visible"},{default:p(()=>[o(re,{ref_key:"scrollbarRef",ref:K,always:"",onScroll:s(ee)},{default:p(()=>[s(M)?(d(),L("div",{key:0,ref_key:"innerRef",ref:C,class:"w-[100%] px-10px"},[(d(!0),L(ge,null,we(s(A),(a,ce)=>(d(),L("div",{key:a.id,class:"w-[100%]"},[S("div",Ye,[a.contentType!==s(T).SYSTEM&&s(se)(a,ce)?(d(),L("div",ze,G(s(Q)(a.createTime)),1)):h("",!0),a.contentType===s(T).SYSTEM?(d(),L("div",Ze,G(a.content),1)):h("",!0)]),S("div",{class:q([[a.senderType===s(D).MEMBER?"ss-row-left":a.senderType===s(D).ADMIN?"ss-row-right":""],"flex mb-20px w-[100%]"])},[a.senderType===s(D).MEMBER?(d(),I(W,{key:0,src:s(n).userAvatar,alt:"avatar",class:"w-60px h-60px"},null,8,["src"])):h("",!0),S("div",{class:q({"kefu-message":s(T).TEXT===a.contentType})},[o(O,{message:a},{default:p(()=>[s(T).TEXT===a.contentType?Z((d(),L("div",qe,null,512)),[[ue,s(g)(s(c)(a).text||a.content)]]):h("",!0)]),_:2},1032,["message"]),o(O,{message:a},{default:p(()=>[s(T).IMAGE===a.contentType?(d(),I(te,{key:0,"initial-index":0,"preview-src-list":[s(c)(a).picUrl||a.content],src:s(c)(a).picUrl||a.content,class:"w-200px mx-10px",fit:"contain","preview-teleported":""},null,8,["preview-src-list","src"])):h("",!0)]),_:2},1032,["message"]),o(O,{message:a},{default:p(()=>[s(T).PRODUCT===a.contentType?(d(),I(Ne,{key:0,picUrl:s(c)(a).picUrl,price:s(c)(a).price,"sales-count":s(c)(a).salesCount,spuId:s(c)(a).spuId,stock:s(c)(a).stock,title:s(c)(a).spuName,class:"max-w-300px mx-10px"},null,8,["picUrl","price","sales-count","spuId","stock","title"])):h("",!0)]),_:2},1032,["message"]),o(O,{message:a},{default:p(()=>[s(T).ORDER===a.contentType?(d(),I(be,{key:0,message:a,class:"max-w-100% mx-10px"},null,8,["message"])):h("",!0)]),_:2},1032,["message"])],2),a.senderType===s(D).ADMIN?(d(),I(W,{key:1,src:a.senderAvatar,alt:"avatar"},null,8,["src"])):h("",!0)],2)]))),128))],512)):h("",!0)]),_:1},8,["onScroll"]),Z(S("div",{class:"newMessageTip flex items-center cursor-pointer",onClick:J},[t[1]||(t[1]=S("span",null,"\u6709\u65B0\u6D88\u606F",-1)),o(le,{class:"ml-5px",icon:"ep:bottom"})],512),[[xe,s(r)]])]),_:1}),o(oe,{class:"kefu-footer"},{default:p(()=>[S("div",Qe,[o(Ie,{onSelectEmoji:f}),o(Se,{class:"ml-15px mt-3px cursor-pointer",onSendPicture:x})]),o(ne,{modelValue:s(i),"onUpdate:modelValue":t[0]||(t[0]=a=>_e(i)?i.value=a:null),rows:6,placeholder:"\u8F93\u5165\u6D88\u606F\uFF0CEnter\u53D1\u9001\uFF0CShift+Enter\u6362\u884C",style:{"border-style":"none"},type:"textarea",onKeyup:ke(Me(H,["prevent"]),["enter"])},null,8,["modelValue","onKeyup"])]),_:1})]),_:1})):(d(),I(z,{key:1,class:"kefu"},{default:p(()=>[o(Y,null,{default:p(()=>[o(ie,{description:"\u8BF7\u9009\u62E9\u5DE6\u4FA7\u7684\u4E00\u4E2A\u4F1A\u8BDD\u540E\u5F00\u59CB"})]),_:1})]),_:1}))}}}),[["__scopeId","data-v-39d9583a"]]);export{ea as default};
