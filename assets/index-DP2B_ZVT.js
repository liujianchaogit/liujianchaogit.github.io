import{h as he,d as we,_ as Ce,c as ge}from"./index-C1TKk8vI.js";import{x as _e,r as l,c as ke,j as Te,y as p,E as w,F as c,O as i,u as t,C as d,K as H,L as K,z as X,J as y,G as xe,l as Y,ai as Oe,n as N}from"./form-create-7GAbgMwl.js";import{C as U}from"./index-jEeLAL_g.js";import{C as Ie}from"./index-WftQHYNa.js";import be from"./ConversationList-CbwB8D7I.js";import{_ as ze}from"./ConversationUpdateForm.vue_vue_type_script_setup_true_lang-B2iQrUBe.js";import Me from"./MessageList-lRZVlWRt.js";import De from"./MessageListEmpty-Bd24YJ_x.js";import Le from"./MessageLoading-BCfa5BVU.js";import Ee from"./MessageNewConversation-BJhgxSSy.js";import{f as Re,X as Se,Y as Ve,D as Be,aa as He,V as Ke}from"./form-designer-BpYekVAY.js";import"./fetch-D5K_4anA.js";import"./RoleRepository-cLH_Jpru.js";import"./RoleHeader-DyVWyY9f.js";import"./RoleList-BRpgu4gP.js";import"./ChatRoleForm.vue_vue_type_script_setup_true_lang-DHIfKaY2.js";import"./Dialog.vue_vue_type_style_index_0_lang-CB5cl-Ts.js";import"./constants-IYPHa1Ih.js";import"./index-BojwE7iS.js";import"./constants-DawjRUyr.js";import"./index-D8bH8MOw.js";import"./index-B7sLP7QQ.js";import"./RoleCategoryList-t-vkaKHn.js";import"./gpt-WhTktY3S.js";import"./formatTime-EbFUBcAO.js";import"./index-CY7R6inO.js";import"./index-DREge7zO.js";import"./MessageKnowledge.vue_vue_type_script_setup_true_lang-tCO3a_hk.js";import"./avatar-BG6NdH5s.js";const Ne={class:"title"},Ue={key:0},$e={key:0,class:"btns"},je=["innerHTML"],qe={class:"message-container"},Ae={class:"prompt-from"},Fe={class:"prompt-btns"},Ge=_e({name:"AiChat",__name:"index",setup(Pe){const $=he(),f=we(),j=l(),n=l(null),u=l(null),r=l(!1),O=l(),s=l([]),C=l(!1),D=l(),T=l(50),L=l(!1),g=l(!1),I=l(),E=l(),m=l(),b=l(!0),_=l(""),z=l(""),q=async e=>{if(!e)return;const a=await Ie.getChatConversationMy(e);a&&(u.value=a,n.value=a.id)},Q=async e=>r.value?(f.alert("\u5BF9\u8BDD\u4E2D\uFF0C\u4E0D\u5141\u8BB8\u5207\u6362!"),!1):(n.value=e.id,u.value=e,await R(),x(!0),m.value="",!0),W=async e=>{n.value===e.id&&await A()},A=async()=>{if(r.value)return f.alert("\u5BF9\u8BDD\u4E2D\uFF0C\u4E0D\u5141\u8BB8\u5207\u6362!"),!1;n.value=null,u.value=null,s.value=[]},F=l(),Z=async()=>{F.value.open(n.value)},ee=async()=>{await q(n.value)},ae=async()=>{await j.value.createConversation()},te=async()=>{m.value=""},R=async()=>{try{if(n.value===null)return;D.value=setTimeout(()=>{C.value=!0},60),s.value=await U.getChatMessageListByConversationId(n.value),await N(),await x()}finally{D.value&&clearTimeout(D.value),C.value=!1}},S=ke(()=>{var e;return s.value.length>0?s.value:(e=u.value)!=null&&e.systemMessage?[{id:0,type:"system",content:u.value.systemMessage}]:[]}),le=()=>{r.value?f.alert("\u56DE\u7B54\u4E2D\uFF0C\u4E0D\u80FD\u5220\u9664!"):R()},ne=async()=>{if(n.value)try{await f.delConfirm("\u786E\u8BA4\u6E05\u7A7A\u5BF9\u8BDD\u6D88\u606F\uFF1F"),await U.deleteByConversationId(n.value),s.value=[]}catch{}},oe=()=>{O.value.handlerGoTop()},se=async e=>{var o;if(g.value||r.value)return;const a=(o=m.value)==null?void 0:o.trim();e.key==="Enter"&&(e.shiftKey?(m.value+=`\r
`,e.preventDefault()):(await M(a),e.preventDefault()))},ie=()=>{var e;M((e=m.value)==null?void 0:e.trim())},ue=e=>{if(!g.value){if(e.data==null)return;g.value=!0}E.value&&clearTimeout(E.value),E.value=setTimeout(()=>{g.value=!1},400)},re=()=>{g.value=!0},ve=()=>{setTimeout(()=>{g.value=!1},200)},M=async e=>{e.length<1?f.error("\u53D1\u9001\u5931\u8D25\uFF0C\u539F\u56E0\uFF1A\u5185\u5BB9\u4E3A\u7A7A\uFF01"):n.value!=null?(m.value="",await ce({conversationId:n.value,content:e})):f.error("\u8FD8\u6CA1\u521B\u5EFA\u5BF9\u8BDD\uFF0C\u4E0D\u80FD\u53D1\u9001!")},ce=async e=>{I.value=new AbortController,r.value=!0,_.value="";try{s.value.push({id:-1,conversationId:n.value,type:"user",content:e.content,createTime:new Date}),s.value.push({id:-2,conversationId:n.value,type:"assistant",content:"\u601D\u8003\u4E2D...",createTime:new Date}),await N(),await x(),de();let a=!0;await U.sendChatMessageStream(e.conversationId,e.content,I.value,b.value,async o=>{const{code:v,data:k,msg:B}=JSON.parse(o.data);v===0?k.receive.content!==""&&(a&&(a=!1,s.value.pop(),s.value.pop(),s.value.push(k.send),s.value.push(k.receive)),_.value=_.value+k.receive.content,await x()):f.alert(`\u5BF9\u8BDD\u5F02\u5E38! ${B}`)},o=>{throw f.alert(`\u5BF9\u8BDD\u5F02\u5E38! ${o}`),V(),o},()=>{V()})}catch{}},V=async()=>{I.value&&I.value.abort(),r.value=!1},me=e=>{m.value=e.content},pe=e=>{M(e.content)},x=async e=>{await N(),O.value&&O.value.scrollToBottom(e)},de=async()=>{let e=0;try{if(L.value)return;L.value=!0,z.value="";const a=async()=>{const v=(_.value.length-z.value.length)/10;T.value=v>5?10:v>2?30:v>1.5?50:100,r.value||(T.value=10),e<_.value.length?(z.value+=_.value[e],e++,s.value[s.value.length-1].content=z.value,await x(),o=setTimeout(a,T.value)):r.value?o=setTimeout(a,T.value):(L.value=!1,clearTimeout(o))};let o=setTimeout(a,T.value)}catch{}};return Te(async()=>{if($.query.conversationId){const e=$.query.conversationId;n.value=e,await q(e)}C.value=!0,await R()}),(e,a)=>{const o=Ce,v=Re,k=Se,B=Ve,fe=Be,ye=He,G=Ke;return p(),w(G,{class:"ai-layout"},{default:c(()=>[i(be,{"active-id":t(n),ref_key:"conversationListRef",ref:j,onOnConversationCreate:te,onOnConversationClick:Q,onOnConversationClear:A,onOnConversationDelete:W},null,8,["active-id"]),i(G,{class:"detail-container"},{default:c(()=>[i(k,{class:"header"},{default:c(()=>{var h,J;return[d("div",Ne,[H(K((h=t(u))!=null&&h.title?(J=t(u))==null?void 0:J.title:"\u5BF9\u8BDD")+" ",1),t(s).length?(p(),X("span",Ue,"("+K(t(s).length)+")",1)):y("",!0)]),t(u)?(p(),X("div",$e,[i(v,{type:"primary",bg:"",plain:"",size:"small",onClick:Z},{default:c(()=>{var P;return[d("span",{innerHTML:(P=t(u))==null?void 0:P.modelName},null,8,je),i(o,{icon:"ep:setting",class:"ml-10px"})]}),_:1}),i(v,{size:"small",class:"btn",onClick:ne},{default:c(()=>[i(o,{icon:"heroicons-outline:archive-box-x-mark",color:"#787878"})]),_:1}),i(v,{size:"small",class:"btn"},{default:c(()=>[i(o,{icon:"ep:download",color:"#787878"})]),_:1}),i(v,{size:"small",class:"btn",onClick:oe},{default:c(()=>[i(o,{icon:"ep:top",color:"#787878"})]),_:1})])):y("",!0)]}),_:1}),i(B,{class:"main-container"},{default:c(()=>[d("div",null,[d("div",qe,[t(C)?(p(),w(Le,{key:0})):y("",!0),t(u)?y("",!0):(p(),w(Ee,{key:1,onOnNewConversation:ae})),!t(C)&&t(S).length===0&&t(u)?(p(),w(De,{key:2,onOnPrompt:M})):y("",!0),!t(C)&&t(S).length>0?(p(),w(Me,{key:3,ref_key:"messageRef",ref:O,conversation:t(u),list:t(S),onOnDeleteSuccess:le,onOnEdit:me,onOnRefresh:pe},null,8,["conversation","list"])):y("",!0)])])]),_:1}),i(ye,{class:"footer-container"},{default:c(()=>[d("form",Ae,[xe(d("textarea",{class:"prompt-input","onUpdate:modelValue":a[0]||(a[0]=h=>Y(m)?m.value=h:null),onKeydown:se,onInput:ue,onCompositionstart:re,onCompositionend:ve,placeholder:"\u95EE\u6211\u4EFB\u4F55\u95EE\u9898...\uFF08Shift+Enter \u6362\u884C\uFF0C\u6309\u4E0B Enter \u53D1\u9001\uFF09"},null,544),[[Oe,t(m)]]),d("div",Fe,[d("div",null,[i(fe,{modelValue:t(b),"onUpdate:modelValue":a[1]||(a[1]=h=>Y(b)?b.value=h:null)},null,8,["modelValue"]),a[3]||(a[3]=d("span",{class:"ml-5px text-14px text-#8f8f8f"},"\u4E0A\u4E0B\u6587",-1))]),t(r)==0?(p(),w(v,{key:0,type:"primary",size:"default",onClick:ie,loading:t(r)},{default:c(()=>[H(K(t(r)?"\u8FDB\u884C\u4E2D":"\u53D1\u9001"),1)]),_:1},8,["loading"])):y("",!0),t(r)==1?(p(),w(v,{key:1,type:"danger",size:"default",onClick:a[2]||(a[2]=h=>V())},{default:c(()=>a[4]||(a[4]=[H(" \u505C\u6B62 ")])),_:1})):y("",!0)])])]),_:1})]),_:1}),i(ze,{ref_key:"conversationUpdateFormRef",ref:F,onSuccess:ee},null,512)]),_:1})}}}),Je=ge(Ge,[["__scopeId","data-v-43d55f99"]]);export{Je as default};
