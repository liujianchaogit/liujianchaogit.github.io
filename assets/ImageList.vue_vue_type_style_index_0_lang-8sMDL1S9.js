import{d as B,u as U}from"./index-C1TKk8vI.js";import{_ as A}from"./index.vue_vue_type_script_setup_true_lang-CrL0kGRz.js";import{I as c}from"./index-DMuhgnKl.js";import G from"./ImageDetail-cDlP6xas.js";import q from"./ImageCard-IuAc_NHy.js";import{a as R}from"./constants-DawjRUyr.js";import{d as D}from"./download-oWiM5xVU.js";import{d as F,f as H,ad as K}from"./form-designer-BpYekVAY.js";import{x as T,X,r as o,j as J,R as Q,y,z as S,O as g,F as w,K as O,C as x,M as C,a4 as V,u as l,E as W}from"./form-create-7GAbgMwl.js";const Y={class:"task-image-pagination"},Z=T({__name:"ImageList",emits:["onRegeneration"],setup($,{expose:E,emit:M}){const I=B(),N=U(),n=X({pageNo:1,pageSize:10}),k=o(0),r=o([]),u=o(),_=o(),v=o({}),p=o(),f=o(!1),h=o(0),j=()=>{N.push({name:"AiImageSquare"})},z=async()=>{f.value=!1},m=async()=>{try{u.value=F.service({target:_.value,text:"\u52A0\u8F7D\u4E2D..."});const{list:e,total:a}=await c.getImagePageMy(n);r.value=e,k.value=a;const s={};r.value.forEach(t=>{t.status===R.IN_PROGRESS&&(s[t.id]=t)}),v.value=s}finally{u.value&&(u.value.close(),u.value=null)}},L=async(e,a)=>e==="more"?(h.value=a.id,void await(async()=>{f.value=!0})()):e==="delete"?(await I.confirm("\u662F\u5426\u5220\u9664\u7167\u7247?"),await c.deleteImageMy(a.id),await m(),void I.success("\u5220\u9664\u6210\u529F!")):void(e!=="download"?e!=="regeneration"||await b("onRegeneration",a):await D.image({url:a.picUrl})),P=async(e,a)=>{const s={id:a.id,customId:e.customId};await c.midjourneyAction(s),await m()};E({getImageList:m});const b=M;return J(async()=>{await m(),p.value=setInterval(async()=>{await(async()=>{const e=Object.keys(v.value).map(Number);if(e.length==0)return;const a=await c.getImageListMyByIds(e),s={};a.forEach(t=>{if(t.status===R.IN_PROGRESS)s[t.id]=t;else{const d=r.value.findIndex(i=>t.id===i.id);d>=0&&(r.value[d]=t)}}),v.value=s})()},3e3)}),Q(async()=>{p.value&&clearInterval(p.value)}),(e,a)=>{const s=H,t=A,d=K;return y(),S(C,null,[g(d,{class:"dr-task","body-class":"task-card",shadow:"never"},{header:w(()=>[a[3]||(a[3]=O(" \u7ED8\u753B\u4EFB\u52A1 ")),g(s,{onClick:j},{default:w(()=>a[2]||(a[2]=[O("\u7ED8\u753B\u4F5C\u54C1")])),_:1})]),default:w(()=>[x("div",{class:"task-image-list",ref_key:"imageListRef",ref:_},[(y(!0),S(C,null,V(l(r),i=>(y(),W(q,{key:i.id,detail:i,onOnBtnClick:L,onOnMjBtnClick:P},null,8,["detail"]))),128))],512),x("div",Y,[g(t,{total:l(k),page:l(n).pageNo,"onUpdate:page":a[0]||(a[0]=i=>l(n).pageNo=i),limit:l(n).pageSize,"onUpdate:limit":a[1]||(a[1]=i=>l(n).pageSize=i),onPagination:m},null,8,["total","page","limit"])])]),_:1}),g(G,{show:l(f),id:l(h),onHandleDrawerClose:z},null,8,["show","id"])],64)}}});export{Z as _};
