import{V as g,a as X,d as Z,aH as $,aS as ee,G as k,F as Y}from"./index-DiGvuAxb.js";import{_ as te}from"./Dialog.vue_vue_type_style_index_0_lang-WG3ZquOK.js";import{_ as ae}from"./Form-DPrhcGPo.js";import{_ as oe}from"./SpuSelect.vue_vue_type_script_setup_true_lang-DkLYCAtq.js";import{_ as ie}from"./SpuAndSkuList.vue_vue_type_script_setup_true_lang-D_wn1iMC.js";import{b as R}from"./formatTime-DeTj2b0K.js";import{r as _}from"./formRules-D4RhDYOS.js";import{u as se}from"./useCrudSchemas-Ds58i6kJ.js";import{P as U,k as re,r as n,l as ne,m as M,G as ce,H as c,u as s,h as ue,z as d,A as le,y as de,E as V,n as pe}from"./form-create-D7wT855o.js";import{b as me}from"./spu-CLGmBlok.js";import{g as fe}from"./index-BTEYh4my.js";import{i as A}from"./constants-C3gLHYOK.js";import{ar as H,f as ve,_ as ye,l as Pe,aj as ge,K as L}from"./form-designer-drfGvdgz.js";const he=U({name:[_],startTime:[_],endTime:[_],discountType:[_]}),Ce=U([{label:"\u6D3B\u52A8\u540D\u79F0",field:"name",isSearch:!0,form:{colProps:{span:24}},table:{width:120}},{label:"\u6D3B\u52A8\u5F00\u59CB\u65F6\u95F4",field:"startTime",formatter:R,isSearch:!0,search:{component:"DatePicker",componentProps:{valueFormat:"YYYY-MM-DD",type:"daterange"}},form:{component:"DatePicker",componentProps:{type:"date",valueFormat:"x"}},table:{width:120}},{label:"\u6D3B\u52A8\u7ED3\u675F\u65F6\u95F4",field:"endTime",formatter:R,isSearch:!0,search:{component:"DatePicker",componentProps:{valueFormat:"YYYY-MM-DD",type:"daterange"}},form:{component:"DatePicker",componentProps:{type:"date",valueFormat:"x"}},table:{width:120}},{label:"\u6D3B\u52A8\u5546\u54C1",field:"spuId",isTable:!0,isSearch:!1,form:{colProps:{span:24}},table:{width:300}},{label:"\u5907\u6CE8",field:"remark",isSearch:!1,form:{component:"Input",componentProps:{type:"textarea",rows:4},colProps:{span:24}},table:{width:300}}]),{allSchemas:we}=se(Ce),ke=async m=>await g.get({url:"/promotion/discount-activity/page",params:m}),_e=async m=>await g.put({url:"/promotion/discount-activity/close?id="+m}),be=async m=>await g.delete({url:"/promotion/discount-activity/delete?id="+m}),Se=re({name:"PromotionDiscountActivityForm",__name:"DiscountActivityForm",emits:["success"],setup(m,{expose:z,emit:G}){const{t:b}=X(),S=Z(),f=n(!1),D=n(""),v=n(!1),F=n(""),y=n(),x=n(),T=n(),j=[{name:"productConfig.discountPrice",rule:e=>e>0,message:"\u5546\u54C1\u4F18\u60E0\u91D1\u989D\u4E0D\u80FD\u4E3A 0 \uFF01\uFF01\uFF01"}],I=n([]),h=n([]),C=n([]),B=(e,t)=>{E(e,t)},E=async(e,t,a,r)=>{var w;if(C.value.includes(e))return void(r!=="load"&&S.error("\u6570\u636E\u91CD\u590D\u9009\u62E9\uFF01"));C.value.push(e);const u=await me([e]);if(u.length==0)return;const i=u[0],p=t===void 0?i==null?void 0:i.skus:(w=i==null?void 0:i.skus)==null?void 0:w.filter(o=>t.includes(o.id));p==null||p.forEach(o=>{let l={skuId:o.id,spuId:i.id,discountType:1,discountPercent:0,discountPrice:0};if(a!==void 0){const P=a.find(W=>W.skuId===o.id);P&&(P.discountPercent=k(P.discountPercent),P.discountPrice=k(P.discountPrice)),l=P||l}o.productConfig=l}),i.skus=p,h.value.push({spuId:i.id,spuDetail:i,propertyList:fe(i)}),I.value.push(i)};z({open:async(e,t)=>{var a;if(f.value=!0,D.value=b("action."+e),F.value=e,await O(),t){v.value=!0;try{const r=await(async u=>await g.get({url:"/promotion/discount-activity/get?id="+u}))(t);for(let u in r.products){const i=r.products[u].spuId;await E(i,(a=r.products)==null?void 0:a.map(p=>p.skuId),r.products,"load")}y.value.setValues(r)}finally{v.value=!1}}}});const K=G,N=async()=>{if(y&&await y.value.getElFormRef().validate()){v.value=!0;try{const e=L(T.value.getSkuConfigs("productConfig"));e.forEach(a=>{a.discountPercent=Y(a.discountPercent),a.discountPrice=Y(a.discountPrice)});const t=L(y.value.formModel);t.products=e,F.value==="create"?(await(async a=>await g.post({url:"/promotion/discount-activity/create",data:a}))(t),S.success(b("common.createSuccess"))):(await(async a=>await g.put({url:"/promotion/discount-activity/update",data:a}))(t),S.success(b("common.updateSuccess"))),f.value=!1,K("success")}finally{v.value=!1}}},q=H(e=>{e.productConfig.discountPrice<=0||(e.productConfig.discountType=A.PRICE.type,e.productConfig.discountPercent=$(e.price-ee(e.productConfig.discountPrice),e.price))},200),J=H(e=>{e.productConfig.discountPercent<=0||e.productConfig.discountPercent>=100||(e.productConfig.discountType=A.PERCENT.type,e.productConfig.discountPrice=k(e.price-e.price*(e.productConfig.discountPercent/100||0)))},200),O=async()=>{I.value=[],h.value=[],C.value=[],await pe(),y.value.getElFormRef().resetFields()},Q=e=>{C.value.splice(C.value.findIndex(t=>t==e),1),h.value.splice(h.value.findIndex(t=>t.spuId==e),1)};return(e,t)=>{const a=ve,r=Pe,u=ye,i=ae,p=te,w=ge;return M(),ne(ce,null,[c(p,{modelValue:s(f),"onUpdate:modelValue":t[2]||(t[2]=o=>ue(f)?f.value=o:null),title:s(D),width:"65%"},{footer:d(()=>[c(a,{disabled:s(v),type:"primary",onClick:N},{default:d(()=>t[4]||(t[4]=[V("\u786E \u5B9A")])),_:1},8,["disabled"]),c(a,{onClick:t[1]||(t[1]=o=>f.value=!1)},{default:d(()=>t[5]||(t[5]=[V("\u53D6 \u6D88")])),_:1})]),default:d(()=>[le((M(),de(i,{ref_key:"formRef",ref:y,isCol:!0,rules:s(he),schema:s(we).formSchema},{spuId:d(()=>[c(a,{onClick:t[0]||(t[0]=o=>s(x).open())},{default:d(()=>t[3]||(t[3]=[V("\u9009\u62E9\u5546\u54C1")])),_:1}),c(s(ie),{ref_key:"spuAndSkuListRef",ref:T,deletable:!0,"rule-config":j,"spu-list":s(I),"spu-property-list-p":s(h),onDelete:Q},{default:d(()=>[c(u,{align:"center",label:"\u4F18\u60E0\u91D1\u989D","min-width":"168"},{default:d(({row:o})=>[c(r,{modelValue:o.productConfig.discountPrice,"onUpdate:modelValue":l=>o.productConfig.discountPrice=l,max:parseFloat(s(k)(o.price)),min:0,precision:2,step:.1,class:"w-100%",onChange:l=>s(q)(o)},null,8,["modelValue","onUpdate:modelValue","max","onChange"])]),_:1}),c(u,{align:"center",label:"\u6298\u6263\u767E\u5206\u6BD4(%)","min-width":"168"},{default:d(({row:o})=>[c(r,{modelValue:o.productConfig.discountPercent,"onUpdate:modelValue":l=>o.productConfig.discountPercent=l,max:100,min:0,precision:2,step:.1,class:"w-100%",onChange:l=>s(J)(o)},null,8,["modelValue","onUpdate:modelValue","onChange"])]),_:1})]),_:1},8,["spu-list","spu-property-list-p"])]),_:1},8,["rules","schema"])),[[w,s(v)]])]),_:1},8,["modelValue","title"]),c(s(oe),{ref_key:"spuSelectRef",ref:x,isSelectSku:!0,onConfirm:B},null,512)],64)}}});export{Se as _,_e as c,be as d,ke as g};
