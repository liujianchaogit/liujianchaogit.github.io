import{e as D,D as M,d as B,u as I}from"./index-C1TKk8vI.js";import{_ as F}from"./ContentWrap.vue_vue_type_script_setup_true_lang-CXvvgLEc.js";import{c as P}from"./index-luWSTt2M.js";import{u as z}from"./tagsView-C2oS-OQq.js";import{a as G}from"./index-CxCrYW_I.js";import{_ as J}from"./ProcessInstanceTimeline.vue_vue_type_script_setup_true_lang-t8BTVj8T.js";import{g as K}from"./index-C52Al6V4.js";import{N as Q,C as X}from"./consts-D6_WKT2v.js";import{Q as Y,x as $,ai as H,F as W,k as Z,f as ee,h as ae,j as te,i as le,aj as re}from"./form-designer-BpYekVAY.js";import{x as ie,r as m,X as se,j as oe,f as ue,y,E as _,F as s,O as l,G as de,u as t,z as me,a4 as ne,M as pe,K as fe}from"./form-create-7GAbgMwl.js";import"./index-vcegfSq2.js";import"./Dialog.vue_vue_type_style_index_0_lang-CB5cl-Ts.js";import"./tree-COGD3qag.js";import"./index-B0Mya_PA.js";import"./index-CZiMqbPE.js";import"./formatTime-EbFUBcAO.js";import"./index-DwSWB2Hs.js";const ve=ie({name:"BpmOALeaveCreate",__name:"create",setup(ce){const f=B(),{delView:A}=z(),{push:x,currentRoute:U}=I(),v=m(!1),i=m({type:void 0,reason:void 0,startTime:void 0,endTime:void 0}),E=se({type:[{required:!0,message:"\u8BF7\u5047\u7C7B\u578B\u4E0D\u80FD\u4E3A\u7A7A",trigger:"blur"}],reason:[{required:!0,message:"\u8BF7\u5047\u539F\u56E0\u4E0D\u80FD\u4E3A\u7A7A",trigger:"change"}],startTime:[{required:!0,message:"\u8BF7\u5047\u5F00\u59CB\u65F6\u95F4\u4E0D\u80FD\u4E3A\u7A7A",trigger:"change"}],endTime:[{required:!0,message:"\u8BF7\u5047\u7ED3\u675F\u65F6\u95F4\u4E0D\u80FD\u4E3A\u7A7A",trigger:"change"}]}),g=m(),n=m([]),d=m({}),c=m({}),h=m([]),b=m(""),O=async()=>{var a,e;if(g&&await g.value.validate()){if(((a=n.value)==null?void 0:a.length)>0){for(const r of n.value)if(Array.isArray(d.value[r.id])&&d.value[r.id].length===0)return f.warning(`\u8BF7\u9009\u62E9${r.name}\u7684\u5BA1\u6279\u4EBA`)}v.value=!0;try{const r={...i.value};((e=n.value)==null?void 0:e.length)>0&&(r.startUserSelectAssignees=d.value),await P(r),f.success("\u53D1\u8D77\u6210\u529F"),A(t(U)),await x({name:"BpmOALeave"})}finally{v.value=!1}}},T=async()=>{var a,e;try{const r=await K({processDefinitionId:b.value,activityId:Q.START_USER_NODE_ID,processVariablesStr:JSON.stringify({day:R()})});if(!r)return void f.error("\u67E5\u8BE2\u4E0D\u5230\u5BA1\u6279\u8BE6\u60C5\u4FE1\u606F\uFF01");if(h.value=r.activityNodes,n.value=(a=r.activityNodes)==null?void 0:a.filter(u=>X.START_USER_SELECT===u.candidateStrategy),((e=n.value)==null?void 0:e.length)>0)for(const u of n.value)c.value[u.id]&&c.value[u.id].length>0?d.value[u.id]=c.value[u.id]:d.value[u.id]=[]}finally{}},N=(a,e)=>{d.value[a]=e==null?void 0:e.map(r=>r.id)},R=()=>{const a=Math.abs(Number(i.value.endTime)-Number(i.value.startTime));return Math.floor(a/864e5)};return oe(async()=>{const a=await G(void 0,"oa_leave");a?(b.value=a.id,n.value=a.startUserSelectTasks,await T()):f.error("OA \u8BF7\u5047\u7684\u6D41\u7A0B\u6A21\u578B\u672A\u914D\u7F6E\uFF0C\u8BF7\u68C0\u67E5\uFF01")}),ue(i.value,(a,e)=>{e&&a&&Object.keys(a).length>0&&(c.value=d.value,d.value={},T())},{immediate:!0}),(a,e)=>{const r=Y,u=$,p=H,V=W,k=Z,C=ee,L=ae,S=F,w=te,j=le,q=re;return y(),_(j,{gutter:20},{default:s(()=>[l(w,{span:16},{default:s(()=>[l(S,{title:"\u7533\u8BF7\u4FE1\u606F"},{default:s(()=>[de((y(),_(L,{ref_key:"formRef",ref:g,model:t(i),rules:t(E),"label-width":"80px"},{default:s(()=>[l(p,{label:"\u8BF7\u5047\u7C7B\u578B",prop:"type"},{default:s(()=>[l(u,{modelValue:t(i).type,"onUpdate:modelValue":e[0]||(e[0]=o=>t(i).type=o),clearable:"",placeholder:"\u8BF7\u9009\u62E9\u8BF7\u5047\u7C7B\u578B"},{default:s(()=>[(y(!0),me(pe,null,ne(t(D)(t(M).BPM_OA_LEAVE_TYPE),o=>(y(),_(r,{key:o.value,label:o.label,value:o.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),l(p,{label:"\u5F00\u59CB\u65F6\u95F4",prop:"startTime"},{default:s(()=>[l(V,{modelValue:t(i).startTime,"onUpdate:modelValue":e[1]||(e[1]=o=>t(i).startTime=o),clearable:"",placeholder:"\u8BF7\u9009\u62E9\u5F00\u59CB\u65F6\u95F4",type:"datetime","value-format":"x"},null,8,["modelValue"])]),_:1}),l(p,{label:"\u7ED3\u675F\u65F6\u95F4",prop:"endTime"},{default:s(()=>[l(V,{modelValue:t(i).endTime,"onUpdate:modelValue":e[2]||(e[2]=o=>t(i).endTime=o),clearable:"",placeholder:"\u8BF7\u9009\u62E9\u7ED3\u675F\u65F6\u95F4",type:"datetime","value-format":"x"},null,8,["modelValue"])]),_:1}),l(p,{label:"\u539F\u56E0",prop:"reason"},{default:s(()=>[l(k,{modelValue:t(i).reason,"onUpdate:modelValue":e[3]||(e[3]=o=>t(i).reason=o),placeholder:"\u8BF7\u8F93\u5165\u8BF7\u5047\u539F\u56E0",type:"textarea"},null,8,["modelValue"])]),_:1}),l(p,null,{default:s(()=>[l(C,{disabled:t(v),type:"primary",onClick:O},{default:s(()=>e[4]||(e[4]=[fe(" \u786E \u5B9A ")])),_:1},8,["disabled"])]),_:1})]),_:1},8,["model","rules"])),[[q,t(v)]])]),_:1})]),_:1}),l(w,{span:8},{default:s(()=>[l(S,{title:"\u5BA1\u6279\u6D41\u7A0B",bodyStyle:{padding:"0 20px 0"}},{default:s(()=>[l(J,{ref:"timelineRef","activity-nodes":t(h),"show-status-icon":!1,onSelectUserConfirm:N},null,8,["activity-nodes"])]),_:1})]),_:1})]),_:1})}}});export{ve as default};
