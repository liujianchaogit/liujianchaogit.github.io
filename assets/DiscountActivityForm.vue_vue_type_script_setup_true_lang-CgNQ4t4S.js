import{V as P,b as Q,d as W,aH as Z,aS as ee,G as k,F as Y}from"./index-C1TKk8vI.js";import{_ as te}from"./Dialog.vue_vue_type_style_index_0_lang-CB5cl-Ts.js";import{_ as oe}from"./Form-D57Ko41z.js";import{_ as ae}from"./SpuSelect.vue_vue_type_script_setup_true_lang-CCllmZHn.js";import{_ as ie}from"./SpuAndSkuList.vue_vue_type_script_setup_true_lang-B3bd3U-D.js";import{b as R}from"./formatTime-EbFUBcAO.js";import{r as b}from"./formRules-NkbEJCk0.js";import{u as se}from"./useCrudSchemas-CYXvU7P5.js";import{X as M,x as re,r as n,y as U,z as ne,O as c,F as d,u as s,K as V,G as ce,E as ue,l as le,M as de,n as pe}from"./form-create-7GAbgMwl.js";import{b as me}from"./spu-75LBH-4N.js";import{g as fe}from"./index-DK77YGos.js";import{i as A}from"./constants-IYPHa1Ih.js";import{ar as K,K as L,f as ve,l as ye,$ as ge,aj as Pe}from"./form-designer-BpYekVAY.js";const he=M({name:[b],startTime:[b],endTime:[b],discountType:[b]}),Ce=M([{label:"\u6D3B\u52A8\u540D\u79F0",field:"name",isSearch:!0,form:{colProps:{span:24}},table:{width:120}},{label:"\u6D3B\u52A8\u5F00\u59CB\u65F6\u95F4",field:"startTime",formatter:R,isSearch:!0,search:{component:"DatePicker",componentProps:{valueFormat:"YYYY-MM-DD",type:"daterange"}},form:{component:"DatePicker",componentProps:{type:"date",valueFormat:"x"}},table:{width:120}},{label:"\u6D3B\u52A8\u7ED3\u675F\u65F6\u95F4",field:"endTime",formatter:R,isSearch:!0,search:{component:"DatePicker",componentProps:{valueFormat:"YYYY-MM-DD",type:"daterange"}},form:{component:"DatePicker",componentProps:{type:"date",valueFormat:"x"}},table:{width:120}},{label:"\u6D3B\u52A8\u5546\u54C1",field:"spuId",isTable:!0,isSearch:!1,form:{colProps:{span:24}},table:{width:300}},{label:"\u5907\u6CE8",field:"remark",isSearch:!1,form:{component:"Input",componentProps:{type:"textarea",rows:4},colProps:{span:24}},table:{width:300}}]),{allSchemas:we}=se(Ce),ke=async m=>await P.get({url:"/promotion/discount-activity/page",params:m}),be=async m=>await P.put({url:"/promotion/discount-activity/close?id="+m}),_e=async m=>await P.delete({url:"/promotion/discount-activity/delete?id="+m}),Se=re({name:"PromotionDiscountActivityForm",__name:"DiscountActivityForm",emits:["success"],setup(m,{expose:G,emit:H}){const{t:_}=Q(),S=W(),f=n(!1),D=n(""),v=n(!1),F=n(""),y=n(),x=n(),T=n(),j=[{name:"productConfig.discountPrice",rule:e=>e>0,message:"\u5546\u54C1\u4F18\u60E0\u91D1\u989D\u4E0D\u80FD\u4E3A 0 \uFF01\uFF01\uFF01"}],I=n([]),h=n([]),C=n([]),q=(e,t)=>{E(e,t)},E=async(e,t,o,r)=>{var w;if(C.value.includes(e))return void(r!=="load"&&S.error("\u6570\u636E\u91CD\u590D\u9009\u62E9\uFF01"));C.value.push(e);const u=await me([e]);if(u.length==0)return;const i=u[0],p=t===void 0?i==null?void 0:i.skus:(w=i==null?void 0:i.skus)==null?void 0:w.filter(a=>t.includes(a.id));p==null||p.forEach(a=>{let l={skuId:a.id,spuId:i.id,discountType:1,discountPercent:0,discountPrice:0};if(o!==void 0){const g=o.find(J=>J.skuId===a.id);g&&(g.discountPercent=k(g.discountPercent),g.discountPrice=k(g.discountPrice)),l=g||l}a.productConfig=l}),i.skus=p,h.value.push({spuId:i.id,spuDetail:i,propertyList:fe(i)}),I.value.push(i)};G({open:async(e,t)=>{var o;if(f.value=!0,D.value=_("action."+e),F.value=e,await $(),t){v.value=!0;try{const r=await(async u=>await P.get({url:"/promotion/discount-activity/get?id="+u}))(t);for(let u in r.products){const i=r.products[u].spuId;await E(i,(o=r.products)==null?void 0:o.map(p=>p.skuId),r.products,"load")}y.value.setValues(r)}finally{v.value=!1}}}});const z=H,N=async()=>{if(y&&await y.value.getElFormRef().validate()){v.value=!0;try{const e=L(T.value.getSkuConfigs("productConfig"));e.forEach(o=>{o.discountPercent=Y(o.discountPercent),o.discountPrice=Y(o.discountPrice)});const t=L(y.value.formModel);t.products=e,F.value==="create"?(await(async o=>await P.post({url:"/promotion/discount-activity/create",data:o}))(t),S.success(_("common.createSuccess"))):(await(async o=>await P.put({url:"/promotion/discount-activity/update",data:o}))(t),S.success(_("common.updateSuccess"))),f.value=!1,z("success")}finally{v.value=!1}}},O=K(e=>{e.productConfig.discountPrice<=0||(e.productConfig.discountType=A.PRICE.type,e.productConfig.discountPercent=Z(e.price-ee(e.productConfig.discountPrice),e.price))},200),X=K(e=>{e.productConfig.discountPercent<=0||e.productConfig.discountPercent>=100||(e.productConfig.discountType=A.PERCENT.type,e.productConfig.discountPrice=k(e.price-e.price*(e.productConfig.discountPercent/100||0)))},200),$=async()=>{I.value=[],h.value=[],C.value=[],await pe(),y.value.getElFormRef().resetFields()},B=e=>{C.value.splice(C.value.findIndex(t=>t==e),1),h.value.splice(h.value.findIndex(t=>t.spuId==e),1)};return(e,t)=>{const o=ve,r=ye,u=ge,i=oe,p=te,w=Pe;return U(),ne(de,null,[c(p,{modelValue:s(f),"onUpdate:modelValue":t[2]||(t[2]=a=>le(f)?f.value=a:null),title:s(D),width:"65%"},{footer:d(()=>[c(o,{disabled:s(v),type:"primary",onClick:N},{default:d(()=>t[4]||(t[4]=[V("\u786E \u5B9A")])),_:1},8,["disabled"]),c(o,{onClick:t[1]||(t[1]=a=>f.value=!1)},{default:d(()=>t[5]||(t[5]=[V("\u53D6 \u6D88")])),_:1})]),default:d(()=>[ce((U(),ue(i,{ref_key:"formRef",ref:y,isCol:!0,rules:s(he),schema:s(we).formSchema},{spuId:d(()=>[c(o,{onClick:t[0]||(t[0]=a=>s(x).open())},{default:d(()=>t[3]||(t[3]=[V("\u9009\u62E9\u5546\u54C1")])),_:1}),c(s(ie),{ref_key:"spuAndSkuListRef",ref:T,deletable:!0,"rule-config":j,"spu-list":s(I),"spu-property-list-p":s(h),onDelete:B},{default:d(()=>[c(u,{align:"center",label:"\u4F18\u60E0\u91D1\u989D","min-width":"168"},{default:d(({row:a})=>[c(r,{modelValue:a.productConfig.discountPrice,"onUpdate:modelValue":l=>a.productConfig.discountPrice=l,max:parseFloat(s(k)(a.price)),min:0,precision:2,step:.1,class:"w-100%",onChange:l=>s(O)(a)},null,8,["modelValue","onUpdate:modelValue","max","onChange"])]),_:1}),c(u,{align:"center",label:"\u6298\u6263\u767E\u5206\u6BD4(%)","min-width":"168"},{default:d(({row:a})=>[c(r,{modelValue:a.productConfig.discountPercent,"onUpdate:modelValue":l=>a.productConfig.discountPercent=l,max:100,min:0,precision:2,step:.1,class:"w-100%",onChange:l=>s(X)(a)},null,8,["modelValue","onUpdate:modelValue","onChange"])]),_:1})]),_:1},8,["spu-list","spu-property-list-p"])]),_:1},8,["rules","schema"])),[[w,s(v)]])]),_:1},8,["modelValue","title"]),c(s(ae),{ref_key:"spuSelectRef",ref:x,isSelectSku:!0,onConfirm:q},null,512)],64)}}});export{Se as _,be as c,_e as d,ke as g};
